generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Masters
model Master {
  id          Int      @id @default(autoincrement())
  cities      String[]
  name        String
  login       String?  @unique
  password    String?
  passportDoc String?  @map("passport_doc")
  contractDoc String?  @map("contract_doc")
  statusWork  String   @map("status_work")
  dateCreate  DateTime @default(now()) @map("date_create")
  note        String?
  tgId        String?  @map("tg_id")
  chatId      String?  @map("chat_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  orders Order[]
  
  @@index([statusWork])
  @@index([name])
  @@index([dateCreate])
  // ✅ FIX: GIN индекс для текстового поиска по name (требует pg_trgm extension)
  // Создать вручную: CREATE INDEX master_name_trgm_idx ON master USING gin (name gin_trgm_ops);
  // CREATE INDEX master_login_trgm_idx ON master USING gin (login gin_trgm_ops);
  @@map("master")
}

// Directors
model Director {
  id           Int      @id @default(autoincrement())
  cities       String[]
  name         String
  login        String   @unique
  password     String
  contractDoc  String?  @map("contract_doc")
  passportDoc  String?  @map("passport_doc")
  dateCreate   DateTime @default(now()) @map("date_create")
  note         String?
  tgId         String?  @map("tg_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  orders       Order[]
  cashApprovals Cash[]  @relation("CashApprover")
  
  @@index([name])
  @@index([dateCreate])
  // ✅ FIX: GIN индекс для текстового поиска
  // Создать вручную: CREATE INDEX director_name_trgm_idx ON director USING gin (name gin_trgm_ops);
  @@map("director")
}

// Call Centre Admins
model CallcentreAdmin {
  id        Int      @id @default(autoincrement())
  login     String   @unique
  password  String
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  orders    Order[]  @relation("CallcentreAdminOrders")
  
  @@map("callcentre_admin")
}

// Call Centre Operators
model CallcentreOperator {
  id             Int       @id @default(autoincrement())
  name           String
  login          String    @unique
  password       String
  city           String
  status         String
  statusWork     String    @map("status_work")
  passport       String?
  contract       String?
  dateCreate     DateTime  @map("date_create")
  note           String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  sipAddress     String?   @map("sip_address")
  
  orders         Order[]   @relation("CallcentreOperatorOrders")
  
  @@index([statusWork])
  @@index([name])
  @@index([dateCreate])
  // ✅ FIX: GIN индекс для текстового поиска
  // Создать вручную: CREATE INDEX callcentre_operator_name_trgm_idx ON callcentre_operator USING gin (name gin_trgm_ops);
  @@map("callcentre_operator")
}

// Order model (for relations only)
// ✅ FIX #149: Исправлены типы для консистентности с другими сервисами
model Order {
  id                    Int       @id @default(autoincrement())
  rk                    String
  city                  String
  avitoName             String?
  phone                 String
  typeOrder             String
  clientName            String
  address               String
  dateMeeting           DateTime  // ✅ FIX: было String
  typeEquipment         String
  problem               String
  callRecord            String?
  statusOrder           String
  masterId              Int?
  result                Decimal?  @db.Decimal(10, 2) // ✅ FIX: было Int
  expenditure           Decimal?  @db.Decimal(10, 2) // ✅ FIX: было Int
  clean                 Decimal?  @db.Decimal(10, 2) // ✅ FIX: было Int
  masterChange          Decimal?  @db.Decimal(10, 2) // ✅ FIX: было Int
  bsoDoc                String[]  @default([])
  expenditureDoc        String[]  @default([])
  operatorNameId        Int
  createDate            DateTime  @default(now())
  closingData           DateTime? // ✅ FIX: было String
  avitoChatId           String?
  callId                String?
  prepayment            Decimal?  @db.Decimal(10, 2) // ✅ FIX: было Int
  dateClosmod           DateTime? // ✅ FIX: было String
  comment               String?
  cashSubmissionStatus  String?
  cashSubmissionDate    DateTime?
  cashSubmissionAmount  Decimal?  @db.Decimal(10, 2) // ✅ FIX: было Int
  cashReceiptDoc        String?
  cashApprovedBy        Int?
  cashApprovedDate      DateTime?
  directorId            Int?
  callcentreAdminId     Int?
  callcentreOperatorId  Int?
  
  // ✅ FIX #146: Добавлены onDelete для предотвращения orphaned records
  master                Master?              @relation(fields: [masterId], references: [id], onDelete: SetNull)
  director              Director?            @relation(fields: [directorId], references: [id], onDelete: SetNull)
  callcentreAdmin       CallcentreAdmin?     @relation("CallcentreAdminOrders", fields: [callcentreAdminId], references: [id], onDelete: SetNull)
  callcentreOperator    CallcentreOperator?  @relation("CallcentreOperatorOrders", fields: [callcentreOperatorId], references: [id], onDelete: SetNull)
  avito                 Avito?               @relation(fields: [avitoChatId], references: [chatId], onDelete: SetNull)
  call                  Call?                @relation(fields: [callId], references: [callId], onDelete: SetNull)
  cash                  Cash?
  
  @@map("order")
}

// Related models (minimal definitions for relations)
model Avito {
  id              Int      @id @default(autoincrement())
  chatId          String   @unique
  city            String?
  name            String?
  phone           String?
  createdAt       DateTime @default(now())
  
  orders          Order[]
  
  @@map("avito")
}

model Call {
  id              Int      @id @default(autoincrement())
  callId          String   @unique @map("call_id")
  phoneClient     String   @map("phone_client")
  dateCreate      DateTime @map("date_create")
  duration        Int?
  recordUrl       String?  @map("record_url")
  
  orders          Order[]
  
  @@map("calls")
}

model Cash {
  id                Int       @id @default(autoincrement())
  orderId           Int       @unique
  amount            Int
  type              String
  status            String
  approvedBy        Int?
  approvedDate      DateTime?
  createdAt         DateTime  @default(now())
  
  // ✅ FIX #146: Cascade для зависимой сущности, SetNull для справочной
  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  approver          Director? @relation("CashApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  
  @@map("cash")
}

// Логи ошибок (shared with auth-service)
model ErrorLog {
  id             Int      @id @default(autoincrement())
  timestamp      DateTime @default(now())
  service        String   @db.VarChar(100)
  errorType      String   @db.VarChar(255)
  errorMessage   String   @db.Text
  stackTrace     String?  @db.Text
  userId         Int?
  userRole       String?  @db.VarChar(50)
  requestUrl     String?  @db.VarChar(500)
  requestMethod  String?  @db.VarChar(10)
  ip             String?  @db.VarChar(45)
  userAgent      String?  @db.Text
  metadata       Json?    @db.JsonB

  @@index([timestamp(sort: Desc)])
  @@index([service, timestamp(sort: Desc)])
  @@index([errorType])
  @@index([userId])
  @@map("error_logs")
}



